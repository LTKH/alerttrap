var menu = {};

(function($) {

    $.fn.treeControl = function(x) {

        if (x.action === "append") {
            if (!(x.path in menu)){
                menu[x.path] = {};
                menu[x.path].name = x.name;
                menu[x.path].options = x.options;
                menu[x.path].levels = { firing: 0, warning: 0, resolved: 0, unknown: 0 };
                var sub = [];
                sub.push('<li id="'+(x.path).replaceAll('/', '_')+'" class="has-sub">');
                sub.push('<a href="'+x.path+'" onclick="loadPage(\''+x.path+'\'); return false;"><b class="empty">&nbsp;</b>');
                //sub.push('<a href="'+x.path+'/'+x.name+'" onclick="loadPage(\''+x.path+'/'+x.name+'\'); return false;"><b class="caret">&nbsp;</b>');
                sub.push(x.name+'<span class="badge"></span></a>');
                sub.push('<ul class="sub-menu closed">');
                sub.push('</ul>');
                sub.push('</li>');
                $('li[id="'+x.path.replace(/\/[^\/]+$/, '').replaceAll('/', '_')+'"] ul:first').append(sub.join('\n'));
                $('li[id="'+x.path.replace(/\/[^\/]+$/, '').replaceAll('/', '_')+'"] b:first').attr('class', 'caret');
            }
        }

        if (x.action === "remove") {
            if (x.path in menu){
                $('li[id="'+x.path.replaceAll('/', '_')+'"]').remove();
                delete(menu[x.path]);
            }
        }

        if (x.action === "create") {
            this.empty();

            var menu_arr = [];

            function getNodes(p, nodes) {
                var sub = [];
                if (nodes.length > 0) {
                    $.each(nodes, function(undefined, n) {
                        menu[p]['options']['slaves'].push(n.path);
                        menu[n.path] = {};
                        menu[n.path].name = n.name;
                        menu[n.path].href = n.href;
                        menu[n.path].tags = n.tags;
                        menu[n.path].options = n.options || {};
                        if (menu[n.path].href != ''){
                            menu[n.path].levels = { firing: 0, warning: 0, resolved: 0, unknown: 0 };
                        }
                        sub.push('<li id="'+n.path.replaceAll('/', '_')+'" class="has-sub">');
                        sub.push('<a href="'+n.path+'" onclick="loadPage(\''+n.path+'\'); return false;"><b ');
                        if (n.nodes) { sub.push('class="caret"'); }
                        sub.push('></b>'+n.name+'<span class="badge"></span></a>');
                        sub.push('<ul class="sub-menu closed">');
                        if (n.nodes) { sub.push(getNodes(p, n.nodes)); }
                        sub.push('</ul>');
                        sub.push('</li>');
                    });
                }
                return sub.join('\n');
            }

            menu_arr.push('<ul class="nav">');
            menu_arr.push('<li class="nav-header">Navigation</li>');
            $.each(x.data, function(undefined, n) {
                menu[n.path] = {};
                menu[n.path].name = n.name;
                menu[n.path].href = n.href;
                menu[n.path].tags = n.tags;
                menu[n.path].options = n.options || {};
                menu[n.path].options.slaves = [];
                menu[n.path].options.slaves.push(n.path);
                n.class = n.class || 'fa fa-th-large';
                menu_arr.push('<li id="'+n.path.replaceAll('/', '_')+'" class="has-sub">');
                menu_arr.push('<a href="'+n.path+'" onclick="newObjects(\''+n.path+'\'); loadPage(\''+n.path+'\'); return false;">');
                menu_arr.push('<i class="'+n.class+'"></i><span>'+n.name+'</span></a>');
                menu_arr.push('<ul class="sub-menu closed">');
                if (n.nodes) { menu_arr.push(getNodes(n.path, n.nodes)); }
                menu_arr.push('</ul>');
                menu_arr.push('</li>');
            });
            menu_arr.push('<li><a href="javascript:;" class="sidebar-minify-btn" data-click="sidebar-minify"><i class="fa fa-angle-double-left"></i></a></li>');
            menu_arr.push('</ul>');
            return this.html(menu_arr.join('\n'));
        }

    };

})(jQuery);